name: Common Jobs

on:
  workflow_call:
    secrets:
      JWT_SECTET:
        required: true
      AUDIO_ENDPOINT:
        required: true
      IMG_ENDPOINT:
        required: true
      # SLACK_CHANNEL_ID:
      #   required: true
      # SLACK_WEBHOOK_URL:
      #   required: true

jobs:
  lint:
    runs-on: ubuntu-22.04
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '18.17.0'
      - name: Configure yarn
        run: yarn set version 1.22.19
      - name: Cache node_modules
        id: cache-nodemodules
        uses: actions/cache@v3
        with:
          path: '**/node_modules'
          key: ${{ runner.os }}-modules-${{ hashFiles('**/yarn.lock') }}
      - name: Install dependencies
        if: steps.cache-nodemodules.outputs.cache-hit != 'true'
        run: yarn install --frozen-lockfile
      - run: yarn lint

  test:
    runs-on: ubuntu-22.04
    needs: lint
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '18.17.0'
      - uses: ./.github/actions/setup-yarn
      - uses: ./.github/actions/setup-mongodb
        with:
          mongodb-version: '4.0'
      - run: yarn codegen
      - run: yarn test

  cypress:
    needs: lint
    permissions:
      contents: read
    env:
      GQL_URL: http://localhost:4000/graphql
      FE_URL: http://localhost:8080
      IMG_ENDPOINT: ${{ secrets.IMG_ENDPOINT }}
      AUDIO_ENDPOINT: ${{ secrets.AUDIO_ENDPOINT }}
      USE_MOCKS: true
      MONGO_CONNECTION: 'mongodb://localhost:27017/test'
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '18.17.0'
      - uses: ./.github/actions/setup-yarn
      - uses: ./.github/actions/setup-mongodb
        with:
          mongodb-version: '4.0'
      - name: Cache Cypress binary
        uses: actions/cache@v3
        with:
          path: ~/.cache/Cypress
          key: cypress-${{ runner.os }}-${{ hashFiles('**/yarn.lock') }}
      - name: Generate code
        run: yarn codegen
      - name: Cypress run
        uses: cypress-io/github-action@v6
        with:
          working-directory: .
          install-command: yarn install --frozen-lockfile
          start: yarn start
          wait-on: 'http://localhost:8080'
          project: ./packages/client
      - name: Upload Cypress screenshots
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: cypress-screenshots
          path: packages/front/cypress/screenshots

  # notify:
  #   needs: [lint, test, cypress]
  #   if: failure()
  #   permissions:
  #     contents: read
  #   runs-on: ubuntu-22.04
  #   steps:
  #     - name: Send Slack notification
  #       uses: slackapi/slack-github-action@v1.24.0
  #       with:
  #         channel-id: ${{ secrets.SLACK_CHANNEL_ID }}
  #         payload: |
  #           {
  #             "text": "Workflow Failed!",
  #             "blocks": [
  #               {
  #                 "type": "section",
  #                 "text": {
  #                   "type": "mrkdwn",
  #                   "text": "*Workflow Failed* :x:\n Repository: ${{ github.repository }}\n Branch: ${{ github.ref }}"
  #                 }
  #               },
  #               {
  #                 "type": "actions",
  #                 "elements": [
  #                   {
  #                     "type": "button",
  #                     "text": {
  #                       "type": "plain_text",
  #                       "text": "View Failed Action"
  #                     },
  #                     "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
  #                   }
  #                 ]
  #               }
  #             ]
  #           }
  #       env:
  #         SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
  #         SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
